!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs")):"function"==typeof define&&define.amd?define(["exports","rxjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).easytools={},e.rxjs)}(this,(function(e,t){"use strict";function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var n=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var n,o,r=s(t);e.SocketCode=void 0,(n=e.SocketCode||(e.SocketCode={}))[n.safe_close=4e3]="safe_close",n[n.error_happen=4001]="error_happen";async function i(e){try{return await navigator.mediaDevices.getUserMedia(e)}catch(e){return null}}async function c(e){const t=await i(e);return t?.getTracks().forEach((e=>{e.stop()})),!!t}e.PermissionType=void 0,(o=e.PermissionType||(e.PermissionType={}))[o.unknow=0]="unknow",o[o.allowed=1]="allowed",o[o.rejected=2]="rejected";function a(e,t,s){return Math.max(s,Math.min(e,t))}e.MediaPermission=class{constraints;__state;stateSub;get obsState(){return this.stateSub.asObservable()}get state(){return this.__state}set state(e){e!==this.__state&&(this.__state=e,this.stateSub.next(e))}constructor(t){this.constraints=t,this.stateSub=new r.Subject,this.state=e.PermissionType.unknow}async requestMediaStream(t=this.constraints){const s=await i(t);return this.state=null!==s?e.PermissionType.allowed:e.PermissionType.rejected,s}async requestPermissions(){const t=await c(this.constraints);return this.state=t?e.PermissionType.allowed:e.PermissionType.rejected,t}},e.Socket=class{url;socket;destory;reconnect;message;retryTimes_left;events;get obsMessage(){return this.message.asObservable()}get obsEvents(){return this.events.asObservable()}messageQueue=[];isConnected=!1;constructor(e,t){this.url=e;const{retry:s}=t??{},{times:n=1/0,intervalSec:o=3}=s??{};this.retryTimes_left=Math.abs(n);const i=1e3*Math.abs(isNaN(o)||isFinite(o)?3:o);this.destory=new r.Subject,this.reconnect=new r.Subject,this.message=new r.Subject,this.events=new r.Subject,this.socket=this.getSocketInstance(),this.reconnect.pipe(r.delay(i),r.takeUntil(this.destory)).subscribe((()=>{this.socket=this.getSocketInstance()}))}getSocketInstance(){this.events.next(new CustomEvent("onGetInstance"));const t=new WebSocket(this.url);return t.onopen=e=>{this.isConnected=!0,this.events.next(e),this.flushMessageQueue()},t.onmessage=e=>{this.events.next(e),this.message.next(e.data)},t.onerror=t=>{this.events.next(t),this.socket.close(e.SocketCode.error_happen)},t.onclose=t=>{switch(this.isConnected=!1,this.events.next(t),t.code){case e.SocketCode.safe_close:break;case e.SocketCode.error_happen:this.retryTimes_left>0&&(this.reconnect.next(),this.retryTimes_left-=1)}},t}flushMessageQueue(){for(;this.messageQueue.length>0&&this.isConnected;){const e=this.messageQueue.shift();e&&this.socket.send(e)}}onSendMessage(e){this.isConnected?(this.events.next(new CustomEvent("onsend")),this.socket.send(e)):(this.events.next(new CustomEvent("onqueue")),this.messageQueue.push(e))}onDestory(){this.socket.close(e.SocketCode.safe_close),this.destory.next(),this.destory.complete(),this.message.complete(),this.events.complete()}},e.SpeechManager=class{audioContext;currentNode;bufferQueue;constructor(e){this.audioContext=e,this.bufferQueue=[],this.currentNode=void 0}addBuffer(e){this.bufferQueue.push(e)}addBufferByFloat32(e,t=1){const s=e.length,n=this.audioContext.sampleRate,o=this.audioContext.createBuffer(t,s,n);for(let s=0;s<t;s++)o.copyToChannel(e,s);this.addBuffer(o)}startSpeech(){return void 0===this.currentNode&&(this.continue(),!0)}nextSpeech(){return this.bufferQueue.length>0&&(this.clearNode(),this.continue(),!0)}stopSpeech(){return this.bufferQueue=[],this.clearNode(),!0}clearNode(){this.currentNode&&(this.currentNode.onended=function(){},this.currentNode.stop(),this.currentNode.disconnect(),this.currentNode=void 0)}continue(){const e=this.bufferQueue.shift();if(e){this.currentNode=this.audioContext.createBufferSource(),this.currentNode.buffer=e,this.currentNode.connect(this.audioContext.destination);const t=this.continue.bind(this);this.currentNode.onended=t,this.currentNode.start()}else this.clearNode()}},e.float32ToInt16=function(e){const t=new DataView(e.buffer),s=[];for(let n=0;n<e.length;n++){const e=a(32768*t.getFloat32(4*n,!0),32767,-32768);s.push(e)}return new Int16Array(s)},e.int16ToFloat32=function(e){const t=new DataView(e.buffer),s=[];for(let n=0;n<e.length;n++){const e=t.getInt16(2*n,!0)/32768;s.push(e)}return new Float32Array(s)},e.requestMediaStream=i,e.requestPermissions=c,e.whitenoise=function(e){const t=2*e.sampleRate,s=e.createBuffer(1,t,e.sampleRate),n=s.getChannelData(0);for(let e=0;e<t;e++)n[e]=2*Math.random()-1;return s}}));
